---
import Layout from '@/layouts/Layout.astro';

const { id } = Astro.params;

// Fetch paste from D1 database
const runtime = Astro.locals.runtime as any;
let paste: any = null;

try {
	const result = await runtime.env.DB.prepare(
		'SELECT * FROM pastes WHERE id = ?'
	).bind(id).first();

	paste = result;

	// Increment view count
	if (paste) {
		await runtime.env.DB.prepare(
			'UPDATE pastes SET views = views + 1 WHERE id = ?'
		).bind(id).run();
	}
} catch (error) {
	console.error('Error fetching paste:', error);
}

if (!paste) {
	return Astro.redirect('/');
}
---

<Layout title={`${id} - pbnj.sh`}>
	<div class="max-w-5xl mx-auto pb-12">
		<div class="mb-6 flex items-center justify-between">
			<h1 class="text-2xl font-medium text-paper-text">
				{id}.{paste.language}
			</h1>
			<div class="flex gap-3">
				<a
					href={`/${id}/raw`}
					class="px-4 py-2 text-sm font-medium text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
				>
					Raw
				</a>
				<button
					id="copy-btn"
					onclick="navigator.clipboard.writeText(document.querySelector('pre code').textContent); const btn = document.getElementById('copy-btn'); const icon = btn.querySelector('svg'); icon.innerHTML = '<path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M5 13l4 4L19 7\"/>'; setTimeout(() => icon.innerHTML = '<rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"></rect><path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"></path>', 2000)"
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="Copy to clipboard"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
					</svg>
				</button>
			</div>
		</div>

		<div class="border border-paper-border rounded-lg overflow-hidden">
			<pre class="p-6 bg-paper-bg2 overflow-x-auto"><code class="text-sm font-mono text-paper-text leading-relaxed">{paste.code}</code></pre>
		</div>
	</div>
</Layout>
