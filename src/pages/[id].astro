---
import Layout from '@/layouts/Layout.astro';

const { id } = Astro.params;

// Fetch paste from D1 database
const runtime = Astro.locals.runtime as any;
let paste: any = null;

try {
	const result = await runtime.env.DB.prepare(
		'SELECT * FROM pastes WHERE id = ?'
	).bind(id).first();

	paste = result;

	// Increment view count
	if (paste) {
		await runtime.env.DB.prepare(
			'UPDATE pastes SET views = views + 1 WHERE id = ?'
		).bind(id).run();
	}
} catch (error) {
	console.error('Error fetching paste:', error);
}

if (!paste) {
	return Astro.redirect('/');
}
---

<Layout title={`${id} - pbnj.sh`}>
	<div class="max-w-6xl mx-auto pb-12">
		<div class="mb-3 flex items-center justify-between">
			<h1 class="text-2xl font-medium text-paper-text">
				{paste.filename || `${id}.${paste.language}`}
			</h1>
			<div class="flex gap-3">
				<a
					href={`/r/${id}`}
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="View raw text"
					aria-label="View raw text"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
						<polyline points="14 2 14 8 20 8"></polyline>
						<line x1="16" y1="13" x2="8" y2="13"></line>
						<line x1="16" y1="17" x2="8" y2="17"></line>
						<polyline points="10 9 9 9 8 9"></polyline>
					</svg>
				</a>
				<button
					id="copy-link-btn"
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="Copy link"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
						<path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
					</svg>
				</button>
				<button
					id="copy-btn"
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="Copy to clipboard"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
					</svg>
				</button>
			</div>
		</div>

		<div class="border border-paper-border rounded overflow-hidden code-block" set:html={paste.highlighted_code} />
	</div>

	<script>
		document.getElementById('copy-btn')?.addEventListener('click', () => {
			const code = document.querySelector('pre code')?.textContent;
			if (code) {
				navigator.clipboard.writeText(code);
				const btn = document.getElementById('copy-btn');
				const icon = btn?.querySelector('svg');
				if (icon) {
					icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>';
					setTimeout(() => {
						icon.innerHTML = '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>';
					}, 2000);
				}
			}
		});

		document.getElementById('copy-link-btn')?.addEventListener('click', () => {
			navigator.clipboard.writeText(window.location.href);
			const btn = document.getElementById('copy-link-btn');
			const icon = btn?.querySelector('svg');
			if (icon) {
				icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>';
				setTimeout(() => {
					icon.innerHTML = '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>';
				}, 2000);
			}
		});
	</script>

	<style is:global>
		.code-block pre {
			margin: 0;
			padding: 1.5rem;
			overflow-x: auto;
			font-size: 0.875rem;
			line-height: 1.625;
		}
		.code-block code {
			font-family: 'SF Mono', Monaco, 'Courier New', monospace;
		}
	</style>
</Layout>
