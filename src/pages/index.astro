---
import Layout from '@/layouts/Layout.astro';

// Fetch pastes from D1 database
const runtime = Astro.locals.runtime as any;
let pastes: any[] = [];

try {
	const { results } = await runtime.env.DB.prepare(
		'SELECT id, language, created, filename, SUBSTR(code, 1, 200) as preview FROM pastes ORDER BY created DESC LIMIT 20'
	).all();

	pastes = results || [];
} catch (error) {
	console.error('Error fetching pastes:', error);
	// If there's an error or no pastes, show empty state
	pastes = [];
}

function formatDate(timestamp: number): string {
	const diff = Date.now() - timestamp;
	const hours = Math.floor(diff / 3600000);
	if (hours < 1) return 'Just now';
	if (hours < 24) return `${hours} hours ago`;
	const days = Math.floor(hours / 24);
	if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
	const weeks = Math.floor(days / 7);
	return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
}
---

<Layout title="pbnj.sh">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

	<div class="max-w-6xl mx-auto pt-6 pb-12">
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
		{pastes.length === 0 && (
			<div class="col-span-full text-center py-12 text-paper-muted">
				No pastes yet. Create your first one!
			</div>
		)}
		{pastes.map((paste) => (
			<a href={`/${paste.id}`} class="group block">
				<div class="h-56 flex flex-col cursor-pointer">
					<div class="flex-1 overflow-hidden relative bg-paper-bg2 rounded preview-block">
						<pre class="m-0 p-4 overflow-hidden text-xs leading-relaxed"><code class={`language-${paste.language}`}>{paste.preview}</code></pre>
						<div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-paper-bg2 to-transparent pointer-events-none"></div>
					</div>
					<div class="py-2.5 bg-paper-bg">
						<div class="text-sm font-medium text-paper-text leading-tight mb-0.5">
							{paste.filename || `${paste.id}.${paste.language}`}
						</div>
						<div class="text-xs text-paper-muted leading-tight">
							{formatDate(paste.created)}
						</div>
					</div>
				</div>
			</a>
		))}
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<script>
		// @ts-ignore
		hljs.highlightAll();
	</script>
</Layout>

<style is:global>
	.preview-block pre {
		background: #F2F0E5 !important;
	}
	.preview-block code {
		font-family: 'SF Mono', Monaco, 'Courier New', monospace;
		background: transparent !important;
	}
	/* Flexoki-inspired highlight.js overrides */
	.hljs {
		background: #F2F0E5 !important;
		color: #100F0F;
	}
	.hljs-keyword,
	.hljs-selector-tag,
	.hljs-built_in,
	.hljs-name,
	.hljs-tag {
		color: #66800B;
	}
	.hljs-string,
	.hljs-title,
	.hljs-section,
	.hljs-attribute,
	.hljs-literal,
	.hljs-template-tag,
	.hljs-template-variable,
	.hljs-type {
		color: #24837B;
	}
	.hljs-number,
	.hljs-meta,
	.hljs-params,
	.hljs-variable,
	.hljs-selector-id,
	.hljs-selector-class {
		color: #5E409D;
	}
	.hljs-function {
		color: #205EA6;
	}
	.hljs-class .hljs-title {
		color: #AD8301;
	}
	.hljs-comment,
	.hljs-quote {
		color: #6F6E69;
		font-style: italic;
	}
	.hljs-doctag,
	.hljs-keyword.hljs-atrule {
		color: #A02F6F;
	}
	.hljs-deletion {
		color: #D14D41;
	}
	.hljs-addition {
		color: #879A39;
	}
</style>
